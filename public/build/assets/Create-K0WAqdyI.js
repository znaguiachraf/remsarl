import{b as G,a as n,j as e,H as J,L as q,r as K}from"./app-B2-XeB62.js";import{P as V}from"./ProjectLayout-UtkpK2bs.js";import{P as W}from"./PrimaryButton-CDmQ7sFW.js";import{S as X}from"./SecondaryButton-CB_UBDw_.js";import{I as l}from"./InputLabel-B_tVklav.js";import{T as m,I as D}from"./TextInput-5yBqEfxz.js";import{c as E,f as T,i as Y,e as Z}from"./Icons-DiwA5nfN.js";import"./AuthErrorHandler-DOuDk2j9.js";import"./Dropdown-Cx7zjFrX.js";import"./transition-C89XB_eo.js";function me({project:p,products:u}){const{currentProject:A}=G().props,c=A?.primary_color||"#3B82F6",[i,f]=n.useState([{product_id:"",quantity:1,unit_price:""}]),[d,j]=n.useState([]),[w,S]=n.useState({}),[_,h]=n.useState(null),[O,C]=n.useState(!1),[k,x]=n.useState({}),v=n.useRef(null);n.useEffect(()=>{const a=t=>{v.current&&!v.current.contains(t.target)&&h(null)};return document.addEventListener("mousedown",a),()=>document.removeEventListener("mousedown",a)},[]);const[L,$]=n.useState({discount:"0"}),R=()=>{f([...i,{product_id:"",quantity:1,unit_price:""}])},B=a=>{f(i.filter((t,s)=>s!==a))},y=(a,t,s)=>{const r=[...i];if(r[a]={...r[a],[t]:s},t==="product_id"){const o=u?.find(N=>N.id.toString()===s);o&&(r[a].unit_price=o.price.toString()),S(N=>({...N,[a]:""})),h(null)}f(r)},P=a=>{const t=(w[a]||"").toLowerCase();return t?(u||[]).filter(s=>s.name.toLowerCase().includes(t)||s.id.toString().includes(t)):u||[]},H=()=>{j([...d,{payment_method:"cash",amount:"",reference:"",payment_date:new Date().toISOString().slice(0,10)}])},z=a=>{j(d.filter((t,s)=>s!==a))},g=(a,t,s)=>{const r=[...d];r[a]={...r[a],[t]:s},j(r)},I=i.reduce((a,t)=>{const s=u?.find(o=>o.id.toString()===t.product_id),r=t.unit_price?parseFloat(t.unit_price):s?.price??0;return a+(t.quantity||0)*r},0),F=parseFloat(L.discount)||0,b=I-F,M=d.reduce((a,t)=>a+(parseFloat(t.amount)||0),0),Q=a=>{a.preventDefault();const t=i.filter(r=>r.product_id&&r.quantity>0).map(r=>({product_id:parseInt(r.product_id,10),quantity:parseInt(r.quantity,10),unit_price:parseFloat(r.unit_price)||0}));if(t.length===0){x({items:"Add at least one product."});return}const s=d.filter(r=>r.amount&&parseFloat(r.amount)>0).map(r=>({payment_method:r.payment_method,amount:parseFloat(r.amount),reference:r.reference||null,payment_date:r.payment_date||new Date().toISOString().slice(0,10)}));if(s.length>0&&s.reduce((r,o)=>r+o.amount,0)>b){x({payments:"Total payments cannot exceed sale total."});return}x({}),C(!0),K.post(route("projects.modules.sales.store",p.id),{items:t,discount:F.toString(),payments:s},{preserveScroll:!0,onFinish:()=>C(!1),onError:r=>x(r)})},U="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-[var(--project-primary)] focus:ring-[var(--project-primary)]";return e.jsxs(V,{header:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(q,{href:route("projects.modules.sales.index",p.id),className:"rounded-lg p-2 text-gray-500 hover:bg-gray-100 hover:text-gray-700",children:e.jsx(Z,{className:"h-5 w-5"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold leading-tight text-gray-800",children:"New Sale"}),e.jsx("p",{className:"mt-0.5 text-sm text-gray-500",children:"Create invoice or order"})]})]})}),children:[e.jsx(J,{title:`${p?.name} - New Sale`}),e.jsxs("form",{onSubmit:Q,className:"space-y-6",children:[e.jsxs("div",{className:"rounded-xl border border-gray-200 bg-white p-6 shadow-sm",children:[e.jsx("h3",{className:"text-base font-medium text-gray-900",children:"Line Items"}),e.jsxs("div",{className:"mt-4 space-y-4",children:[i.map((a,t)=>e.jsxs("div",{className:"flex flex-wrap items-end gap-4 rounded-lg border border-gray-100 bg-gray-50/50 p-4",children:[e.jsxs("div",{className:"relative min-w-[200px] flex-1",ref:_===t?v:null,children:[e.jsx(l,{value:"Product"}),e.jsxs("div",{className:"relative",children:[e.jsx(m,{type:"text",placeholder:"Search product...",value:a.product_id?u?.find(s=>s.id.toString()===a.product_id)?.name||"":w[t]||"",onChange:s=>{const r=s.target.value;a.product_id&&y(t,"product_id",""),S(o=>({...o,[t]:r})),h(t)},onFocus:()=>h(t),className:"block w-full",required:t===0&&!a.product_id,autoComplete:"off"}),_===t&&e.jsx("ul",{className:"absolute z-10 mt-1 max-h-48 w-full overflow-auto rounded-md border border-gray-200 bg-white py-1 shadow-lg",children:P(t).length===0?e.jsx("li",{className:"px-4 py-2 text-sm text-gray-500",children:"No products found"}):P(t).map(s=>e.jsxs("li",{className:"cursor-pointer px-4 py-2 text-sm hover:bg-gray-100",onClick:()=>y(t,"product_id",s.id.toString()),children:[s.name," — ",Number(s.price).toLocaleString()," (",s.stock," in stock)"]},s.id))})]})]}),e.jsxs("div",{className:"w-24",children:[e.jsx(l,{value:"Qty"}),e.jsx(m,{type:"number",min:"1",value:a.quantity,onChange:s=>y(t,"quantity",s.target.value),className:"block w-full"})]}),e.jsxs("div",{className:"w-32",children:[e.jsx(l,{value:"Unit Price"}),e.jsx(m,{type:"number",step:"0.01",min:"0",value:a.unit_price,onChange:s=>y(t,"unit_price",s.target.value),className:"block w-full"})]}),e.jsx("div",{className:"w-28 text-right font-medium text-gray-700",children:((a.quantity||0)*(parseFloat(a.unit_price)||0)).toLocaleString()}),i.length>1&&e.jsx("button",{type:"button",onClick:()=>B(t),className:"rounded p-2 text-red-600 hover:bg-red-50",children:e.jsx(E,{className:"h-4 w-4"})})]},t)),e.jsxs("button",{type:"button",onClick:R,className:"flex items-center gap-2 text-sm font-medium transition hover:opacity-80",style:{color:c},children:[e.jsx(T,{className:"h-4 w-4"})," Add line"]})]}),e.jsx(D,{message:k.items})]}),e.jsxs("div",{className:"rounded-xl border p-6 shadow-sm",style:{borderColor:`${c}40`,backgroundColor:`${c}08`},children:[e.jsx("h3",{className:"text-base font-medium text-gray-900",children:"Totals"}),e.jsxs("div",{className:"mt-4 grid max-w-xs gap-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Subtotal"}),e.jsx("span",{children:I.toLocaleString()})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(l,{value:"Discount"}),e.jsx(m,{type:"number",step:"0.01",min:"0",value:L.discount,onChange:a=>$(t=>({...t,discount:a.target.value})),className:"block w-24"})]}),e.jsxs("div",{className:"flex justify-between border-t pt-2 font-medium",style:{borderColor:`${c}40`},children:[e.jsx("span",{style:{color:c},children:"Total"}),e.jsxs("span",{className:"text-lg",style:{color:c},children:[e.jsx(Y,{className:"inline h-4 w-4"})," ",b.toLocaleString()]})]})]})]}),e.jsxs("div",{className:"rounded-xl border border-gray-200 bg-white p-6 shadow-sm",children:[e.jsx("h3",{className:"text-base font-medium text-gray-900",children:"Payments (optional — leave empty for unpaid)"}),e.jsxs("div",{className:"mt-4 space-y-4",children:[d.map((a,t)=>e.jsxs("div",{className:"flex flex-wrap items-end gap-4 rounded-lg border border-gray-100 bg-gray-50/50 p-4",children:[e.jsxs("div",{className:"w-32",children:[e.jsx(l,{value:"Method"}),e.jsxs("select",{value:a.payment_method,onChange:s=>g(t,"payment_method",s.target.value),className:U,children:[e.jsx("option",{value:"cash",children:"Cash"}),e.jsx("option",{value:"card",children:"Card"}),e.jsx("option",{value:"transfer",children:"Transfer"}),e.jsx("option",{value:"check",children:"Check"}),e.jsx("option",{value:"other",children:"Other"})]})]}),e.jsxs("div",{className:"w-32",children:[e.jsx(l,{value:"Amount"}),e.jsx(m,{type:"number",step:"0.01",min:"0.01",value:a.amount,onChange:s=>g(t,"amount",s.target.value),className:"block w-full"})]}),e.jsxs("div",{className:"w-36",children:[e.jsx(l,{value:"Date"}),e.jsx(m,{type:"date",value:a.payment_date,onChange:s=>g(t,"payment_date",s.target.value),className:"block w-full"})]}),e.jsxs("div",{className:"w-40",children:[e.jsx(l,{value:"Reference"}),e.jsx(m,{value:a.reference,onChange:s=>g(t,"reference",s.target.value),className:"block w-full"})]}),e.jsx("button",{type:"button",onClick:()=>z(t),className:"rounded p-2 text-red-600 hover:bg-red-50",children:e.jsx(E,{className:"h-4 w-4"})})]},t)),e.jsxs("button",{type:"button",onClick:H,className:"flex items-center gap-2 text-sm font-medium transition hover:opacity-80",style:{color:c},children:[e.jsx(T,{className:"h-4 w-4"})," Add payment"]}),d.length>0&&e.jsxs("p",{className:"text-sm text-gray-500",children:["Payments total: ",M.toLocaleString()," / ",b.toLocaleString()]})]}),e.jsx(D,{message:k.payments})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(q,{href:route("projects.modules.sales.index",p.id),children:e.jsx(X,{type:"button",children:"Cancel"})}),e.jsx(W,{type:"submit",disabled:O,children:"Create Sale"})]})]})]})}export{me as default};
