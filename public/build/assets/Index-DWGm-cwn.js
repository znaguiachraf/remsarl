import{b as ye,a as n,j as e,H as fe,L as je,r as q}from"./app-D_JLr605.js";import{P as be}from"./ProjectLayout-BLz5VXiF.js";import{I as E}from"./InputError-u89X4fmg.js";import{I as w}from"./InputLabel-DQ2v9w2u.js";import{T as k}from"./TextInput-CUhroNdz.js";import{M as K}from"./SecondaryButton-C5Psiqnm.js";import"./AuthErrorHandler-DUQsMJae.js";import"./Dropdown-BPdzR8s0.js";import"./transition-BeUOXmgI.js";function Le({project:m,session:o,products:I,categories:Q=[],can:y}){const{currentProject:A,flash:$,payment_methods:X=[]}=ye().props,a=A?.primary_color||"#3B82F6",D=A?.secondary_color||"#10B981",[l,h]=n.useState([]),[F,Z]=n.useState(""),[B,S]=n.useState("0"),[u,T]=n.useState("fixed"),[ee,f]=n.useState(!1),[O,R]=n.useState(""),[te,x]=n.useState(!1),[V,se]=n.useState("cash"),[W,_]=n.useState(""),[j,M]=n.useState([]),[b,p]=n.useState(!1),[v,i]=n.useState({}),[N,re]=n.useState(""),[ae,P]=n.useState(!1),H=n.useRef(null),ne=n.useMemo(()=>{let t=I||[];const s=(F||"").toLowerCase().trim();if(s&&(t=t.filter(r=>r.name.toLowerCase().includes(s)||r.id.toString().includes(s))),N){const r=parseInt(N,10);t=t.filter(c=>c.category_id===r)}return t},[I,F,N]),oe=n.useCallback(()=>{H.current?.requestFullscreen?.().then(()=>{P(!0)}).catch(()=>{})},[]),le=n.useCallback(()=>{document.exitFullscreen?.().then(()=>{P(!1)}).catch(()=>{})},[]);n.useEffect(()=>{const t=()=>{P(!!document.fullscreenElement)};return document.addEventListener("fullscreenchange",t),()=>document.removeEventListener("fullscreenchange",t)},[]);const ie=n.useCallback(t=>{const s=l.find(r=>r.product_id===t.id);h(s?l.map(r=>r.product_id===t.id?{...r,quantity:r.quantity+1}:r):[...l,{product_id:t.id,name:t.name,quantity:1,unit_price:t.price}])},[l]),ce=n.useCallback((t,s,r)=>{h(c=>{const L=[...c];return L[t]={...L[t],[s]:r},s==="quantity"&&parseInt(r,10)<=0?c.filter((ve,ge)=>ge!==t):L})},[]),de=n.useCallback(t=>{h(s=>s.filter((r,c)=>c!==t))},[]),me=n.useCallback(()=>{h([]),M([]),x(!1),_("")},[]),g=l.reduce((t,s)=>t+s.quantity*(s.unit_price||0),0),z=parseFloat(B)||0,C=u==="percent"?Math.min(g,g*z/100):Math.min(g,z),U=Math.max(0,g-C),Y=j.reduce((t,s)=>t+(parseFloat(s.amount)||0),0),d=U-Y,ue=()=>{const t=parseFloat(W)||0;if(!(t<=0)){if(t>d){i({payment:"Amount exceeds remaining due."});return}M(s=>[...s,{payment_method:V,amount:t.toString()}]),_(""),x(!1),i({})}},xe=t=>{M(s=>s.filter((r,c)=>c!==t))},pe=()=>{i({});const t=l.filter(r=>r.quantity>0).map(r=>({product_id:r.product_id,quantity:parseInt(r.quantity,10),unit_price:parseFloat(r.unit_price)||0}));if(t.length===0){i({items:"Add at least one product to the cart."});return}const s=j.filter(r=>parseFloat(r.amount)>0).map(r=>({payment_method:r.payment_method,amount:parseFloat(r.amount),reference:null}));p(!0),q.post(route("projects.modules.pos.orders.store",m.id),{items:t,discount:C,payments:s},{preserveScroll:!0,onFinish:()=>p(!1),onSuccess:()=>{me(),S("0"),T("fixed")},onError:r=>i(r)})},G=t=>{t?.preventDefault?.(),pe()},J=t=>{t.preventDefault(),p(!0),q.post(route("projects.modules.pos.session.open",m.id),{},{preserveScroll:!0,onFinish:()=>p(!1),onError:s=>i(s)})},he=t=>{t.preventDefault();const s=parseFloat(O);if(isNaN(s)||s<0){i({closing_cash:"Enter a valid closing cash amount."});return}p(!0),q.post(route("projects.modules.pos.session.close",[m.id,o.id]),{closing_cash:s},{preserveScroll:!0,onFinish:()=>p(!1),onSuccess:()=>{f(!1),R("")},onError:r=>i(r)})};return e.jsxs(be,{header:e.jsxs("div",{className:"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(je,{href:route("projects.show",m.id),className:"rounded-lg p-2 text-gray-500 hover:bg-gray-100 hover:text-gray-700",children:e.jsx("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10 19l-7-7m0 0l7-7m-7 7h18"})})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-800",children:"Point of Sale"}),e.jsx("p",{className:"text-sm text-gray-500",children:m.name})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[o&&e.jsx(e.Fragment,{children:e.jsx("button",{type:"button",onClick:oe,title:"Fullscreen",className:"rounded-lg border p-2 transition hover:opacity-90",style:{borderColor:`${a}40`,backgroundColor:`${a}10`,color:a},children:e.jsx("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"})})})}),o?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2 rounded-lg border px-4 py-2",style:{borderColor:o.status==="open"?a:"#9CA3AF",backgroundColor:o.status==="open"?`${a}15`:"#F3F4F6"},children:[e.jsx("span",{className:"h-2.5 w-2.5 rounded-full",style:{backgroundColor:o.status==="open"?a:"#9CA3AF"}}),e.jsxs("span",{className:"text-sm font-medium text-gray-700",children:["Session ",o.session_number," • ",o.status==="open"?"Open":"Closed"]})]}),y.close_session&&o.status==="open"&&e.jsx("button",{type:"button",onClick:()=>f(!0),className:"rounded-lg border border-red-200 bg-white px-4 py-2 text-sm font-medium text-red-700 hover:bg-red-50",children:"Close Session"})]}):y.open_session&&e.jsx("button",{type:"button",onClick:J,disabled:b,className:"rounded-lg px-4 py-2 text-sm font-medium text-white",style:{backgroundColor:a},children:"Open Session"})]})]}),children:[e.jsx(fe,{title:`POS - ${m.name}`}),$?.success&&e.jsx("div",{className:"mb-4 rounded-lg p-4 text-sm font-medium",style:{backgroundColor:`${a}15`,color:a},children:$.success}),o?e.jsxs("div",{ref:H,className:"flex min-h-0 flex-col rounded-xl bg-white p-4 md:min-h-[calc(100vh-12rem)] md:p-6 lg:min-h-[calc(100vh-10rem)] [&:fullscreen]:p-6",style:{"--project-primary":a,"--project-secondary":D},children:[ae&&e.jsx("div",{className:"mb-4 flex justify-end",children:e.jsxs("button",{type:"button",onClick:le,title:"Exit fullscreen",className:"flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-medium text-white transition hover:opacity-90",style:{backgroundColor:D},children:[e.jsx("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})}),"Exit fullscreen"]})}),e.jsxs("div",{className:"grid flex-1 gap-4 md:grid-cols-3 md:gap-6 lg:gap-8",children:[e.jsxs("div",{className:"flex min-h-0 flex-col md:col-span-2",children:[e.jsxs("div",{className:"mb-3 flex flex-col gap-3 sm:flex-row sm:items-center",children:[e.jsx(k,{type:"search",placeholder:"Search products by name or ID...",value:F,onChange:t=>Z(t.target.value),className:"w-full sm:flex-1",autoFocus:!0}),e.jsxs("select",{value:N,onChange:t=>re(t.target.value),className:"rounded-md border-gray-300 text-sm focus:border-[var(--project-primary)] focus:ring-[var(--project-primary)] sm:w-40",children:[e.jsx("option",{value:"",children:"All categories"}),Q.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),e.jsx("div",{className:"grid min-h-0 flex-1 grid-cols-2 gap-2 overflow-y-auto sm:grid-cols-3 md:grid-cols-3 md:gap-3 lg:grid-cols-4 lg:gap-4",children:ne.map(t=>e.jsxs("button",{type:"button",onClick:()=>ie(t),className:"flex flex-col rounded-lg border border-gray-200 bg-white p-3 text-left shadow-sm transition hover:border-[var(--project-primary)] hover:shadow md:p-4",children:[e.jsx("span",{className:"truncate text-sm font-medium text-gray-900 md:text-base",children:t.name}),e.jsx("span",{className:"mt-1 text-sm font-semibold",style:{color:a},children:(t.price||0).toFixed(2)}),t.stock!==void 0&&e.jsxs("span",{className:"mt-0.5 text-xs text-gray-500",children:["Stock: ",t.stock]})]},t.id))})]}),e.jsxs("div",{className:"flex min-h-0 flex-col rounded-xl border bg-white shadow-sm md:min-h-[400px]",style:{borderColor:`${a}30`},children:[e.jsx("div",{className:"shrink-0 border-b px-4 py-3",style:{borderColor:`${a}20`},children:e.jsx("h3",{className:"font-semibold",style:{color:a},children:"Cart"})}),e.jsx("div",{className:"min-h-0 flex-1 overflow-y-auto p-4 md:max-h-72",children:l.length===0?e.jsx("p",{className:"text-center text-sm text-gray-500",children:"Cart is empty"}):e.jsx("ul",{className:"space-y-2",children:l.map((t,s)=>e.jsxs("li",{className:"flex items-center justify-between gap-2 rounded-lg bg-gray-50 p-2",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("span",{className:"block truncate text-sm font-medium",children:t.name}),e.jsxs("div",{className:"mt-1 flex items-center gap-2",children:[e.jsx("input",{type:"number",min:"1",value:t.quantity,onChange:r=>ce(s,"quantity",r.target.value),className:"w-16 rounded border border-gray-300 px-2 py-1 text-sm"}),e.jsxs("span",{className:"text-xs text-gray-500",children:["× ",(t.unit_price||0).toFixed(2)]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-sm font-semibold",children:(t.quantity*(t.unit_price||0)).toFixed(2)}),e.jsx("button",{type:"button",onClick:()=>de(s),className:"rounded p-1 text-red-600 hover:bg-red-50",children:e.jsx("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})})]})]},`${t.product_id}-${s}`))})}),e.jsxs("div",{className:"border-t border-gray-200 p-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Subtotal"}),e.jsx("span",{children:g.toFixed(2)})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx(w,{className:"text-xs shrink-0",children:"Discount"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsxs("select",{value:u,onChange:t=>{T(t.target.value),S("0")},className:"rounded border border-gray-300 text-sm focus:border-[var(--project-primary)] focus:ring-[var(--project-primary)]",children:[e.jsx("option",{value:"fixed",children:"Fixed"}),e.jsx("option",{value:"percent",children:"%"})]}),e.jsx(k,{type:"number",min:"0",step:u==="percent"?"1":"0.01",max:u==="percent"?"100":void 0,value:B,onChange:t=>S(t.target.value),className:"w-20",placeholder:u==="percent"?"%":"0.00"}),u==="percent"&&e.jsx("span",{className:"text-xs text-gray-500",children:"%"})]}),C>0&&e.jsxs("span",{className:"text-xs text-gray-500",children:["(",C.toFixed(2)," off)"]})]}),e.jsxs("div",{className:"flex justify-between border-t pt-2 font-semibold",style:{borderColor:`${a}30`},children:[e.jsx("span",{style:{color:a},children:"Total"}),e.jsx("span",{style:{color:a},children:U.toFixed(2)})]})]}),j.length>0&&e.jsxs("div",{className:"mt-3 space-y-1",children:[e.jsx("p",{className:"text-xs font-medium text-gray-600",children:"Payments"}),j.map((t,s)=>e.jsxs("div",{className:"flex items-center justify-between rounded bg-gray-50 px-2 py-1 text-sm",children:[e.jsx("span",{className:"capitalize",children:t.payment_method}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:(parseFloat(t.amount)||0).toFixed(2)}),e.jsx("button",{type:"button",onClick:()=>xe(s),className:"text-red-600 hover:underline",children:"Remove"})]})]},s)),e.jsxs("div",{className:"flex justify-between text-sm font-medium",children:[e.jsx("span",{children:"Paid"}),e.jsx("span",{children:Y.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Remaining"}),e.jsx("span",{children:d.toFixed(2)})]})]}),d>0&&l.length>0&&e.jsx("button",{type:"button",onClick:()=>x(!0),className:"mt-3 w-full rounded-lg border py-2 text-sm font-medium transition hover:opacity-90",style:{borderColor:a,color:a,backgroundColor:`${a}10`},children:"Add Payment"}),e.jsx(E,{message:v.items||v.payments,className:"mt-2"}),e.jsx("button",{type:"button",onClick:G,disabled:b||l.length===0||d>0||!y.create_order,className:"mt-4 w-full rounded-lg py-3 text-lg font-semibold text-white disabled:opacity-50",style:{backgroundColor:a},children:"Complete Sale"})]})]})]})]}):e.jsxs("div",{className:"flex flex-col items-center justify-center rounded-xl border-2 border-dashed p-12 text-center",style:{borderColor:`${a}40`,backgroundColor:`${a}08`},children:[e.jsx("svg",{className:"mx-auto h-16 w-16",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",style:{color:`${a}60`},children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"})}),e.jsx("h3",{className:"mt-4 text-lg font-medium text-gray-900",children:"No open session"}),e.jsx("p",{className:"mt-2 max-w-sm text-gray-600",children:"Open a session to start making sales. You can only have one open session at a time."}),y.open_session&&e.jsx("button",{type:"button",onClick:J,disabled:b,className:"mt-6 rounded-lg px-6 py-3 text-white",style:{backgroundColor:a},children:"Open Session"})]}),e.jsx(K,{show:ee,onClose:()=>f(!1),children:e.jsxs("form",{onSubmit:he,className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Close Session"}),e.jsxs("p",{className:"mt-1 text-sm text-gray-600",children:["Enter the closing cash count for session ",o?.session_number,"."]}),e.jsxs("div",{className:"mt-4",children:[e.jsx(w,{htmlFor:"closing_cash",children:"Closing Cash"}),e.jsx(k,{id:"closing_cash",type:"number",min:"0",step:"0.01",value:O,onChange:t=>R(t.target.value),className:"mt-1 w-full",required:!0}),e.jsx(E,{message:v.closing_cash,className:"mt-1"})]}),e.jsxs("div",{className:"mt-6 flex justify-end gap-3",children:[e.jsx("button",{type:"button",onClick:()=>f(!1),className:"rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50",children:"Cancel"}),e.jsx("button",{type:"submit",disabled:b,className:"rounded-lg bg-red-600 px-4 py-2 text-sm font-medium text-white hover:bg-red-700 disabled:opacity-50",children:"Close Session"})]})]})}),e.jsx(K,{show:te,onClose:()=>x(!1),children:e.jsxs("form",{onSubmit:t=>{t.preventDefault(),ue()},className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Add Payment"}),e.jsxs("p",{className:"mt-1 text-sm text-gray-600",children:["Remaining due: ",d.toFixed(2)]}),e.jsxs("div",{className:"mt-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx(w,{htmlFor:"payment_method",children:"Method"}),e.jsx("select",{id:"payment_method",value:V,onChange:t=>se(t.target.value),className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-[var(--project-primary)] focus:ring-[var(--project-primary)]",children:X.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))})]}),e.jsxs("div",{children:[e.jsx(w,{htmlFor:"payment_amount",children:"Amount"}),e.jsx(k,{id:"payment_amount",type:"number",min:"0.01",step:"0.01",value:W,onChange:t=>_(t.target.value),placeholder:d.toFixed(2),className:"mt-1 w-full",required:!0}),e.jsx(E,{message:v.payment,className:"mt-1"})]})]}),e.jsxs("div",{className:"mt-6 flex flex-wrap justify-end gap-3",children:[d>0&&e.jsx("button",{type:"button",onClick:()=>{x(!1),G()},className:"rounded-lg border border-amber-300 bg-amber-50 px-4 py-2 text-sm font-medium text-amber-800 hover:bg-amber-100",children:"Complete as Unpaid"}),e.jsx("button",{type:"button",onClick:()=>x(!1),className:"rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50",children:"Cancel"}),e.jsx("button",{type:"submit",className:"rounded-lg px-4 py-2 text-sm font-medium text-white",style:{backgroundColor:a},children:"Add Payment"})]})]})})]})}export{Le as default};
