import{b as se,a as n,j as e,H as ae,L as V,r as re}from"./app-CV_ed7_i.js";import{P as ne}from"./ProjectLayout-CCBX1sk_.js";import{P as oe}from"./PrimaryButton-fG5qMxE-.js";import{S as le}from"./SecondaryButton-PnKEJt8F.js";import{I as o}from"./InputLabel-Covi2RWO.js";import{T as i}from"./TextInput-BQNjFm02.js";import{I as $}from"./InputError-chaytR5f.js";import{h as O,j as B,b as ce,i as ie}from"./Icons-CUEBKkf-.js";import"./AuthErrorHandler-CZjHl6Ix.js";import"./Dropdown-BLtL5ZC7.js";import"./transition-wRWBGdP0.js";const de=20;function we({project:x,products:p,default_tva_rate:k}){const{currentProject:M,payment_methods:L=[]}=se().props,l=M?.primary_color||"#3B82F6",H=k!=null?Number(k):de,[d,v]=n.useState([{product_id:"",quantity:1,unit_price:""}]),[m,b]=n.useState([]),[I,P]=n.useState({}),[A,h]=n.useState(null),[U,F]=n.useState(!1),[D,g]=n.useState({}),[u,z]=n.useState(!1),[q,Q]=n.useState(H.toString()),N=n.useRef(null);n.useEffect(()=>{const a=t=>{N.current&&!N.current.contains(t.target)&&h(null)};return document.addEventListener("mousedown",a),()=>document.removeEventListener("mousedown",a)},[]);const[E,G]=n.useState({discount:"0"}),J=()=>{v([...d,{product_id:"",quantity:1,unit_price:""}])},K=a=>{v(d.filter((t,s)=>s!==a))},y=(a,t,s)=>{const r=[...d];if(r[a]={...r[a],[t]:s},t==="product_id"){const c=p?.find(T=>T.id.toString()===s);c&&(r[a].unit_price=c.price.toString()),P(T=>({...T,[a]:""})),h(null)}v(r)},R=a=>{const t=(I[a]||"").toLowerCase();return t?(p||[]).filter(s=>s.name.toLowerCase().includes(t)||s.id.toString().includes(t)):p||[]},W=()=>{b([...m,{payment_method:L[0]?.value||"cash",amount:"",reference:"",payment_date:new Date().toISOString().slice(0,10)}])},X=a=>{b(m.filter((t,s)=>s!==a))},j=(a,t,s)=>{const r=[...m];r[a]={...r[a],[t]:s},b(r)},w=d.reduce((a,t)=>{const s=p?.find(c=>c.id.toString()===t.product_id),r=t.unit_price?parseFloat(t.unit_price):s?.price??0;return a+(t.quantity||0)*r},0),S=parseFloat(E.discount)||0,f=parseFloat(q)||0,Y=Math.max(0,w-S),_=u&&f>0?Math.round(Y*(f/100)*100)/100:0,C=w-S+_,Z=m.reduce((a,t)=>a+(parseFloat(t.amount)||0),0),ee=a=>{a.preventDefault();const t=d.filter(r=>r.product_id&&r.quantity>0).map(r=>({product_id:parseInt(r.product_id,10),quantity:parseInt(r.quantity,10),unit_price:parseFloat(r.unit_price)||0}));if(t.length===0){g({items:"Add at least one product."});return}const s=m.filter(r=>r.amount&&parseFloat(r.amount)>0).map(r=>({payment_method:r.payment_method,amount:parseFloat(r.amount),reference:r.reference||null,payment_date:r.payment_date||new Date().toISOString().slice(0,10)}));if(s.length>0&&s.reduce((r,c)=>r+c.amount,0)>C){g({payments:"Total payments cannot exceed sale total."});return}g({}),F(!0),re.post(route("projects.modules.sales.store",x.id),{items:t,discount:S.toString(),include_tva:u,tva_rate:f,payments:s},{preserveScroll:!0,onFinish:()=>F(!1),onError:r=>g(r)})},te="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-[var(--project-primary)] focus:ring-[var(--project-primary)]";return e.jsxs(ne,{header:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(V,{href:route("projects.modules.sales.index",x.id),className:"rounded-lg p-2 text-gray-500 hover:bg-gray-100 hover:text-gray-700",children:e.jsx(ie,{className:"h-5 w-5"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold leading-tight text-gray-800",children:"New Sale"}),e.jsx("p",{className:"mt-0.5 text-sm text-gray-500",children:"Create invoice or order"})]})]})}),children:[e.jsx(ae,{title:`${x?.name} - New Sale`}),e.jsxs("form",{onSubmit:ee,className:"space-y-6",children:[e.jsxs("div",{className:"rounded-xl border border-gray-200 bg-white p-6 shadow-sm",children:[e.jsx("h3",{className:"text-base font-medium text-gray-900",children:"Line Items"}),e.jsxs("div",{className:"mt-4 space-y-4",children:[d.map((a,t)=>e.jsxs("div",{className:"flex flex-wrap items-end gap-4 rounded-lg border border-gray-100 bg-gray-50/50 p-4",children:[e.jsxs("div",{className:"relative min-w-[200px] flex-1",ref:A===t?N:null,children:[e.jsx(o,{value:"Product"}),e.jsxs("div",{className:"relative",children:[e.jsx(i,{type:"text",placeholder:"Search product...",value:a.product_id?p?.find(s=>s.id.toString()===a.product_id)?.name||"":I[t]||"",onChange:s=>{const r=s.target.value;a.product_id&&y(t,"product_id",""),P(c=>({...c,[t]:r})),h(t)},onFocus:()=>h(t),className:"block w-full",required:t===0&&!a.product_id,autoComplete:"off"}),A===t&&e.jsx("ul",{className:"absolute z-10 mt-1 max-h-48 w-full overflow-auto rounded-md border border-gray-200 bg-white py-1 shadow-lg",children:R(t).length===0?e.jsx("li",{className:"px-4 py-2 text-sm text-gray-500",children:"No products found"}):R(t).map(s=>e.jsxs("li",{className:"cursor-pointer px-4 py-2 text-sm hover:bg-gray-100",onClick:()=>y(t,"product_id",s.id.toString()),children:[s.name," — ",Number(s.price).toLocaleString()," (",s.stock," in stock)"]},s.id))})]})]}),e.jsxs("div",{className:"w-24",children:[e.jsx(o,{value:"Qty"}),e.jsx(i,{type:"number",min:"1",value:a.quantity,onChange:s=>y(t,"quantity",s.target.value),className:"block w-full"})]}),e.jsxs("div",{className:"w-32",children:[e.jsx(o,{value:"Unit Price"}),e.jsx(i,{type:"number",step:"0.01",min:"0",value:a.unit_price,onChange:s=>y(t,"unit_price",s.target.value),className:"block w-full"})]}),e.jsx("div",{className:"w-28 text-right font-medium text-gray-700",children:((a.quantity||0)*(parseFloat(a.unit_price)||0)).toLocaleString()}),d.length>1&&e.jsx("button",{type:"button",onClick:()=>K(t),className:"rounded p-2 text-red-600 hover:bg-red-50",children:e.jsx(O,{className:"h-4 w-4"})})]},t)),e.jsxs("button",{type:"button",onClick:J,className:"flex items-center gap-2 text-sm font-medium transition hover:opacity-80",style:{color:l},children:[e.jsx(B,{className:"h-4 w-4"})," Add line"]})]}),e.jsx($,{message:D.items})]}),e.jsxs("div",{className:"rounded-xl border p-6 shadow-sm",style:{borderColor:`${l}40`,backgroundColor:`${l}08`},children:[e.jsx("h3",{className:"text-base font-medium text-gray-900",children:"Totals"}),e.jsxs("div",{className:"mt-4 grid max-w-sm gap-3",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Subtotal"}),e.jsx("span",{children:w.toLocaleString()})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(o,{value:"Discount"}),e.jsx(i,{type:"number",step:"0.01",min:"0",value:E.discount,onChange:a=>G(t=>({...t,discount:a.target.value})),className:"block w-24"})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-4 border-t pt-3",style:{borderColor:`${l}30`},children:[e.jsxs("label",{className:"flex cursor-pointer items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:u,onChange:a=>z(a.target.checked),className:"rounded border-gray-300"}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Include TVA (VAT)"})]}),u&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(o,{value:"TVA rate"}),e.jsx(i,{type:"number",step:"0.01",min:"0",max:"100",value:q,onChange:a=>Q(a.target.value),className:"block w-20"}),e.jsx("span",{className:"text-sm text-gray-500",children:"%"})]})]}),u&&_>0&&e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-gray-600",children:["TVA (",f,"%)"]}),e.jsx("span",{children:_.toLocaleString()})]}),e.jsxs("div",{className:"flex justify-between border-t pt-2 font-medium",style:{borderColor:`${l}40`},children:[e.jsx("span",{style:{color:l},children:u?"Total (TTC)":"Total"}),e.jsxs("span",{className:"text-lg",style:{color:l},children:[e.jsx(ce,{className:"inline h-4 w-4"})," ",C.toLocaleString()]})]}),u&&e.jsx("p",{className:"text-xs text-gray-500",children:"TTC = All taxes included. Invoice will show TVA included."})]})]}),e.jsxs("div",{className:"rounded-xl border border-gray-200 bg-white p-6 shadow-sm",children:[e.jsx("h3",{className:"text-base font-medium text-gray-900",children:"Payments (optional — leave empty for unpaid)"}),e.jsxs("div",{className:"mt-4 space-y-4",children:[m.map((a,t)=>e.jsxs("div",{className:"flex flex-wrap items-end gap-4 rounded-lg border border-gray-100 bg-gray-50/50 p-4",children:[e.jsxs("div",{className:"w-32",children:[e.jsx(o,{value:"Method"}),e.jsx("select",{value:a.payment_method,onChange:s=>j(t,"payment_method",s.target.value),className:te,children:L.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]}),e.jsxs("div",{className:"w-32",children:[e.jsx(o,{value:"Amount"}),e.jsx(i,{type:"number",step:"0.01",min:"0.01",value:a.amount,onChange:s=>j(t,"amount",s.target.value),className:"block w-full"})]}),e.jsxs("div",{className:"w-36",children:[e.jsx(o,{value:"Date"}),e.jsx(i,{type:"date",value:a.payment_date,onChange:s=>j(t,"payment_date",s.target.value),className:"block w-full"})]}),e.jsxs("div",{className:"w-40",children:[e.jsx(o,{value:"Reference"}),e.jsx(i,{value:a.reference,onChange:s=>j(t,"reference",s.target.value),className:"block w-full"})]}),e.jsx("button",{type:"button",onClick:()=>X(t),className:"rounded p-2 text-red-600 hover:bg-red-50",children:e.jsx(O,{className:"h-4 w-4"})})]},t)),e.jsxs("button",{type:"button",onClick:W,className:"flex items-center gap-2 text-sm font-medium transition hover:opacity-80",style:{color:l},children:[e.jsx(B,{className:"h-4 w-4"})," Add payment"]}),m.length>0&&e.jsxs("p",{className:"text-sm text-gray-500",children:["Payments total: ",Z.toLocaleString()," / ",C.toLocaleString()]})]}),e.jsx($,{message:D.payments})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(V,{href:route("projects.modules.sales.index",x.id),children:e.jsx(le,{type:"button",children:"Cancel"})}),e.jsx(oe,{type:"submit",disabled:U,children:"Create Sale"})]})]})]})}export{we as default};
