import{b as J,a as n,j as e,H as K,L as T,r as V}from"./app-fSu64WR-.js";import{P as W}from"./ProjectLayout-CqaUciwo.js";import{P as X}from"./PrimaryButton-BvYeoX1B.js";import{S as Y}from"./SecondaryButton-CM4f6Nua.js";import{I as o}from"./InputLabel-DP1sH5mm.js";import{T as c,I as E}from"./TextInput-QgXqvZmf.js";import{c as A,f as O,i as Z,e as ee}from"./Icons-D69-dGj2.js";import"./AuthErrorHandler-BuFZfN6N.js";import"./Dropdown-BdlvtOVr.js";import"./transition-CncNDczQ.js";function me({project:p,products:m}){const{currentProject:R}=J().props,u=R?.primary_color||"#3B82F6",[i,y]=n.useState([{product_id:"",quantity:1,unit_price:""}]),[d,v]=n.useState([]),[S,_]=n.useState({}),[C,x]=n.useState(null),[$,k]=n.useState(!1),[L,h]=n.useState({}),b=n.useRef(null);n.useEffect(()=>{const s=t=>{b.current&&!b.current.contains(t.target)&&x(null)};return document.addEventListener("mousedown",s),()=>document.removeEventListener("mousedown",s)},[]);const[g,P]=n.useState({discount:"0",tax:"0"}),B=()=>{y([...i,{product_id:"",quantity:1,unit_price:""}])},H=s=>{y(i.filter((t,a)=>a!==s))},f=(s,t,a)=>{const r=[...i];if(r[s]={...r[s],[t]:a},t==="product_id"){const l=m?.find(w=>w.id.toString()===a);l&&(r[s].unit_price=l.price.toString()),_(w=>({...w,[s]:""})),x(null)}y(r)},I=s=>{const t=(S[s]||"").toLowerCase();return t?(m||[]).filter(a=>a.name.toLowerCase().includes(t)||a.id.toString().includes(t)):m||[]},z=()=>{v([...d,{payment_method:"cash",amount:"",reference:"",payment_date:new Date().toISOString().slice(0,10)}])},M=s=>{v(d.filter((t,a)=>a!==s))},j=(s,t,a)=>{const r=[...d];r[s]={...r[s],[t]:a},v(r)},F=i.reduce((s,t)=>{const a=m?.find(l=>l.id.toString()===t.product_id),r=t.unit_price?parseFloat(t.unit_price):a?.price??0;return s+(t.quantity||0)*r},0),q=parseFloat(g.discount)||0,D=parseFloat(g.tax)||0,N=F-q+D,Q=d.reduce((s,t)=>s+(parseFloat(t.amount)||0),0),U=s=>{s.preventDefault();const t=i.filter(r=>r.product_id&&r.quantity>0).map(r=>({product_id:parseInt(r.product_id,10),quantity:parseInt(r.quantity,10),unit_price:parseFloat(r.unit_price)||0}));if(t.length===0){h({items:"Add at least one product."});return}const a=d.filter(r=>r.amount&&parseFloat(r.amount)>0).map(r=>({payment_method:r.payment_method,amount:parseFloat(r.amount),reference:r.reference||null,payment_date:r.payment_date||new Date().toISOString().slice(0,10)}));if(a.length>0&&a.reduce((r,l)=>r+l.amount,0)>N){h({payments:"Total payments cannot exceed sale total."});return}h({}),k(!0),V.post(route("projects.modules.sales.store",p.id),{items:t,discount:q.toString(),tax:D.toString(),payments:a},{preserveScroll:!0,onFinish:()=>k(!1),onError:r=>h(r)})},G="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500";return e.jsxs(W,{header:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(T,{href:route("projects.modules.sales.index",p.id),className:"rounded-lg p-2 text-gray-500 hover:bg-gray-100 hover:text-gray-700",children:e.jsx(ee,{className:"h-5 w-5"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold leading-tight text-gray-800",children:"New Sale"}),e.jsx("p",{className:"mt-0.5 text-sm text-gray-500",children:"Create invoice or order"})]})]})}),children:[e.jsx(K,{title:`${p?.name} - New Sale`}),e.jsxs("form",{onSubmit:U,className:"space-y-6",children:[e.jsxs("div",{className:"rounded-xl border border-gray-200 bg-white p-6 shadow-sm",children:[e.jsx("h3",{className:"text-base font-medium text-gray-900",children:"Line Items"}),e.jsxs("div",{className:"mt-4 space-y-4",children:[i.map((s,t)=>e.jsxs("div",{className:"flex flex-wrap items-end gap-4 rounded-lg border border-gray-100 bg-gray-50/50 p-4",children:[e.jsxs("div",{className:"relative min-w-[200px] flex-1",ref:C===t?b:null,children:[e.jsx(o,{value:"Product"}),e.jsxs("div",{className:"relative",children:[e.jsx(c,{type:"text",placeholder:"Search product...",value:s.product_id?m?.find(a=>a.id.toString()===s.product_id)?.name||"":S[t]||"",onChange:a=>{const r=a.target.value;s.product_id&&f(t,"product_id",""),_(l=>({...l,[t]:r})),x(t)},onFocus:()=>x(t),className:"block w-full",required:t===0&&!s.product_id,autoComplete:"off"}),C===t&&e.jsx("ul",{className:"absolute z-10 mt-1 max-h-48 w-full overflow-auto rounded-md border border-gray-200 bg-white py-1 shadow-lg",children:I(t).length===0?e.jsx("li",{className:"px-4 py-2 text-sm text-gray-500",children:"No products found"}):I(t).map(a=>e.jsxs("li",{className:"cursor-pointer px-4 py-2 text-sm hover:bg-gray-100",onClick:()=>f(t,"product_id",a.id.toString()),children:[a.name," — ",Number(a.price).toLocaleString()," (",a.stock," in stock)"]},a.id))})]})]}),e.jsxs("div",{className:"w-24",children:[e.jsx(o,{value:"Qty"}),e.jsx(c,{type:"number",min:"1",value:s.quantity,onChange:a=>f(t,"quantity",a.target.value),className:"block w-full"})]}),e.jsxs("div",{className:"w-32",children:[e.jsx(o,{value:"Unit Price"}),e.jsx(c,{type:"number",step:"0.01",min:"0",value:s.unit_price,onChange:a=>f(t,"unit_price",a.target.value),className:"block w-full"})]}),e.jsx("div",{className:"w-28 text-right font-medium text-gray-700",children:((s.quantity||0)*(parseFloat(s.unit_price)||0)).toLocaleString()}),i.length>1&&e.jsx("button",{type:"button",onClick:()=>H(t),className:"rounded p-2 text-red-600 hover:bg-red-50",children:e.jsx(A,{className:"h-4 w-4"})})]},t)),e.jsxs("button",{type:"button",onClick:B,className:"flex items-center gap-2 text-sm font-medium text-indigo-600 hover:text-indigo-500",children:[e.jsx(O,{className:"h-4 w-4"})," Add line"]})]}),e.jsx(E,{message:L.items})]}),e.jsxs("div",{className:"rounded-xl border p-6 shadow-sm",style:{borderColor:`${u}40`,backgroundColor:`${u}08`},children:[e.jsx("h3",{className:"text-base font-medium text-gray-900",children:"Totals"}),e.jsxs("div",{className:"mt-4 grid max-w-xs gap-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Subtotal"}),e.jsx("span",{children:F.toLocaleString()})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(o,{value:"Discount"}),e.jsx(c,{type:"number",step:"0.01",min:"0",value:g.discount,onChange:s=>P(t=>({...t,discount:s.target.value})),className:"block w-24"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(o,{value:"Tax"}),e.jsx(c,{type:"number",step:"0.01",min:"0",value:g.tax,onChange:s=>P(t=>({...t,tax:s.target.value})),className:"block w-24"})]}),e.jsxs("div",{className:"flex justify-between border-t pt-2 font-medium",style:{borderColor:`${u}40`},children:[e.jsx("span",{style:{color:u},children:"Total"}),e.jsxs("span",{className:"text-lg",style:{color:u},children:[e.jsx(Z,{className:"inline h-4 w-4"})," ",N.toLocaleString()]})]})]})]}),e.jsxs("div",{className:"rounded-xl border border-gray-200 bg-white p-6 shadow-sm",children:[e.jsx("h3",{className:"text-base font-medium text-gray-900",children:"Payments (optional — leave empty for unpaid)"}),e.jsxs("div",{className:"mt-4 space-y-4",children:[d.map((s,t)=>e.jsxs("div",{className:"flex flex-wrap items-end gap-4 rounded-lg border border-gray-100 bg-gray-50/50 p-4",children:[e.jsxs("div",{className:"w-32",children:[e.jsx(o,{value:"Method"}),e.jsxs("select",{value:s.payment_method,onChange:a=>j(t,"payment_method",a.target.value),className:G,children:[e.jsx("option",{value:"cash",children:"Cash"}),e.jsx("option",{value:"card",children:"Card"}),e.jsx("option",{value:"transfer",children:"Transfer"}),e.jsx("option",{value:"check",children:"Check"}),e.jsx("option",{value:"other",children:"Other"})]})]}),e.jsxs("div",{className:"w-32",children:[e.jsx(o,{value:"Amount"}),e.jsx(c,{type:"number",step:"0.01",min:"0.01",value:s.amount,onChange:a=>j(t,"amount",a.target.value),className:"block w-full"})]}),e.jsxs("div",{className:"w-36",children:[e.jsx(o,{value:"Date"}),e.jsx(c,{type:"date",value:s.payment_date,onChange:a=>j(t,"payment_date",a.target.value),className:"block w-full"})]}),e.jsxs("div",{className:"w-40",children:[e.jsx(o,{value:"Reference"}),e.jsx(c,{value:s.reference,onChange:a=>j(t,"reference",a.target.value),className:"block w-full"})]}),e.jsx("button",{type:"button",onClick:()=>M(t),className:"rounded p-2 text-red-600 hover:bg-red-50",children:e.jsx(A,{className:"h-4 w-4"})})]},t)),e.jsxs("button",{type:"button",onClick:z,className:"flex items-center gap-2 text-sm font-medium text-indigo-600 hover:text-indigo-500",children:[e.jsx(O,{className:"h-4 w-4"})," Add payment"]}),d.length>0&&e.jsxs("p",{className:"text-sm text-gray-500",children:["Payments total: ",Q.toLocaleString()," / ",N.toLocaleString()]})]}),e.jsx(E,{message:L.payments})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(T,{href:route("projects.modules.sales.index",p.id),children:e.jsx(Y,{type:"button",children:"Cancel"})}),e.jsx(X,{type:"submit",disabled:$,children:"Create Sale"})]})]})]})}export{me as default};
